!function(e,t){for(var a in t)e[a]=t[a]}(exports,function(e){var t={};function a(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,a),o.l=!0,o.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)a.d(n,o,function(t){return e[t]}.bind(null,o));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=9)}([function(e,t){e.exports=require("fs-extra")},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TMP_PREFIX="tmp/",t.TARGET_PREFIX="dist/"},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(0),o=a(1);t.loadData=async()=>{t.character_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/character_table.json","utf-8")),t.handbook_info_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/handbook_info_table.json","utf-8")),t.handbook_team_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/handbook_team_table.json","utf-8")),t.item_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/item_table.json","utf-8")),t.skill_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/skill_table.json","utf-8")),t.skin_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/skin_table.json","utf-8")),t.stage_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/stage_table.json","utf-8")),t.enemy_handbook_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/enemy_handbook_table.json","utf-8")),t.charword_table=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/excel/charword_table.json","utf-8"));const e=JSON.parse(await n.readFile(o.TMP_PREFIX+"ArknightsGameData/levels/enemydata/enemy_database.json","utf-8"));t.enemy_table=e.enemies.reduce((e,t)=>(e[t.Key]=t.Value,e),{}),t.char_extra_table=JSON.parse(await n.readFile("src/patch/char.json","utf-8"))}},function(e,t){e.exports=require("lodash")},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(13),o=a(3);t.toLuaObject=(e,a=0)=>{const n="    ".repeat(a),r=a>0?"    ".repeat(a-1):"";if("object"==typeof e&&null!==e){if(Array.isArray(e)){if(e.some(e=>"object"==typeof e)?e.length>3:e.length>10){const o=e.map(e=>t.toLuaObject(e,a+1)).join(`, \n${n}`);return"{\n"+n+o+"\n"+r+"}"}return"{"+e.map(e=>t.toLuaObject(e,a)).join(", ")+"}"}{const i=o.filter(e,e=>null!==e),s=i.length>2||i.some(e=>"object"==typeof e),l=o.map(e,(e,o)=>null===e?null:s?o.match(/^\w[\d\w]*$/)?n+`${o} = ${t.toLuaObject(e,a+1)},\n`:n+`["${o}"] = ${t.toLuaObject(e)},\n`:o.match(/^\w[\d\w]*$/)?`${o} = ${t.toLuaObject(e,a+1)}, `:`["${o}"] = ${t.toLuaObject(e)}, `).filter(e=>null!==e);return s?`{\n${l.join("")}${r}}`:`{ ${l.join("")}}`}}return JSON.stringify(e)},t.convertObjectToLua=(e,a,n=(a.endsWith("ies")?a.substr(0,a.length-3)+"y":a.endsWith("s")?a.substr(0,a.length-1):a)+"Data")=>{return`-- AUTOMATIC GENERATED, DO NOT EDIT\n-- see https://github.com/pa001024/arks\n\nlocal ${n} = {\n    ["${a}"] = {\n        ${e.map(e=>`["${e.name}"] = ${t.toLuaObject(e,3)}`).join(",\n        ")}\n    },\n}\nreturn ${n}`},t.formatJSON=e=>n.format("string"==typeof e?e:JSON.stringify(e),{parser:"json"}),t.isEmpty=e=>Array.isArray(e)?e.every(e=>t.isEmpty(e)):!e||"object"==typeof e&&!Object.keys(e).length,t.firstCase=e=>e[0].toUpperCase()+e.substr(1),t.purge=e=>(Object.keys(e).forEach(t=>0!==e[t]&&!e[t]&&delete e[t]),e),t.json2Tab=(e,t="自动管理模板v1.0")=>{const a={},n=e.map(e=>o.map(e,(e,t)=>(a[t]||(a[t]={name:t,type:typeof e,title:{en:t}}),e)));return{license:"CC0-1.0",description:{en:t},sources:"AUTOMATIC GENERATED BY https://github.com/pa001024/arks",schema:{fields:o.map(a)},data:n}};const r=a(7);t.forEachLimit=(e,t=5,a)=>new Promise(n=>{r.default.forEachLimit(e,t,a,e=>{n()})});const i=a(14);t.imgSizeOf=i.promisify(a(15))},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("chalk")},function(e,t){e.exports=require("async")},function(e,t){e.exports=require("child-process-promise")},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(10),o=a(24),r=a(25);a(31).usage("$0 <cmd> [args]").scriptName("arks-parser").command("build [mode]","build from source",{mode:{type:"string",default:"",describe:"the mode name"}},async function(e){await n.default(e.mode)}).command("sync [mode]","sync online",{mode:{type:"string",default:"module",describe:"the mode name"},force:{alias:"f",type:"boolean",default:"",describe:"force update"},skip:{type:"string",default:"",describe:"skip to some file name"}},async function(e){await r.default(e)}).command("clean [module]","clean online",{},async function(e){await o.default()}).help().argv},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(0),o=a(1),r=a(6),i=a(3),s=a(7),l=a(8),c=a(5),d=a(2),u=a(11),p=a(16),m=a(4),f=a(17),g=a(19),h=a(20),y=a(21),_=a(22);let b,w,k;const v=async(e="")=>{const t=f.translateStage(),a=i.map(t,f.translateStagePreview);if("map"===e){await n.ensureDir(o.TARGET_PREFIX+"maps");for(let e=0;e<a.length;e++){const[t,o]=a[e];await n.pathExists(t)&&!await n.pathExists(o)&&(console.log(r.default.green("[map] convert"),`${c.basename(t)} => ${c.basename(o)}`),await l.exec(`magick convert "${c.resolve(t)}" -resize 512x288! "${o}"`))}}const s=m.convertObjectToLua(t,"Stages");await n.outputFile(o.TARGET_PREFIX+"StageData.lua",s),await n.outputFile(o.TARGET_PREFIX+"Stage.sync.json",m.formatJSON(t.map(e=>({title:e.name,text:"{{InfoboxStage}}{{NavboxStage}}"}))))};t.default=async(e="")=>{n.ensureDir(o.TARGET_PREFIX),await d.loadData(),e&&"all"!==e||(console.log("[build] STEP1: convertCharacter Start"),await(async()=>{b=i.map(d.character_table,(e,t)=>u.translateCharacter(Object.assign({id:t},e),d.handbook_info_table.handbookDict[t])),w=b.filter(e=>e.displayNumber),await n.writeFile(o.TARGET_PREFIX+"CharacterFlat.json",m.formatJSON(b));const e=m.convertObjectToLua(b,"Characters");await n.writeFile(o.TARGET_PREFIX+"CharacterData.lua",e),await n.writeFile(o.TMP_PREFIX+"character_array.json",m.formatJSON(b))})(),console.log("[build] STEP2: convertItem Start"),await(async()=>{const e=i.map(d.item_table.items,p.translateItem),t=m.convertObjectToLua(e,"Items");await n.writeFile(o.TARGET_PREFIX+"ItemData.lua",t)})(),console.log("[build] STEP3: convertStage Start"),await v(),console.log("[build] STEP4: convertEnemy Start"),await(async()=>{const e=i.map(d.enemy_handbook_table,g.translateEnemy),t=m.convertObjectToLua(e,"Enemies");await n.writeFile(o.TARGET_PREFIX+"EnemyData.lua",t),await n.writeFile(o.TARGET_PREFIX+"Enemy.sync.json",m.formatJSON(e.map(e=>({title:e.name,text:"{{InfoboxEnemy}}{{NavboxEnemy}}"}))))})(),console.log("[build] STEP5: convertCharHandbook Start"),await(async()=>{const e=i.map(d.handbook_info_table.handbookDict,e=>{if(!d.character_table[e.charID])return void(e.charID.startsWith("npc")||console.log(r.default.red("[Convert Char Handbook] charid not found"),e.charID));const t=d.character_table[e.charID].name;return{title:`${t}/人员档案`,text:e.storyTextAudio.map(e=>{const t=e.stories[0];return`{{情报\n|storyTitle=${e.storyTitle}\n|storyText=${(e=>e.replace(/\n/g,"<br>").replace(/\. /g,".&nbsp;"))(t.storyText)}\n|unLockType=${t.unLockType}\n|unLockParam=${t.unLockParam}\n|unLockString=${t.unLockString}\n}}`}).join("\n")}}).filter(Boolean),t=i.map(d.handbook_info_table.handbookDict,e=>{if(d.character_table[e.charID])return{title:`${d.character_table[e.charID].name}`,text:"{{干员页面}}"}}).filter(Boolean);await n.writeFile(o.TARGET_PREFIX+"Char.sync.json",m.formatJSON(t)),await n.writeFile(o.TARGET_PREFIX+"CharHandbook.sync.json",m.formatJSON(e))})(),console.log("[build] STEP6: convertSkill Start"),await(async()=>{const e=i.map(d.skill_table,h.translateSkill);k=e.reduce((e,t)=>(e[t.name]=t,e),{});const t=m.convertObjectToLua(i.map(k),"Skills");await n.writeFile(o.TARGET_PREFIX+"SkillData.lua",t),await n.writeFile(o.TARGET_PREFIX+"SkillFlat.json",m.formatJSON(e))})(),console.log("[build] STEP7.5: convertCharSkill Start"),await(async()=>{const e=w.map(e=>({title:e.name+"/技能天赋",text:"{{#invoke:Character|renderSkillGroup}}"}));await n.writeFile(o.TARGET_PREFIX+"CharSkill.sync.json",m.formatJSON(e))})(),console.log("[build] STEP7.6: convertCharWord Start"),await(async()=>{const e=y.translateCharword(),t=m.json2Tab(i.map(e)),a=w.map(e=>({title:e.name+"/语音互动",text:"{{#invoke:Charword|charword}}<noinclude>[[分类:语音]]</noinclude>"}));await n.writeFile(o.TARGET_PREFIX+"CharWord.sync.json",m.formatJSON(a)),await n.writeFile(o.TARGET_PREFIX+"CharWord.tab.json",JSON.stringify(t))})()),"char"!==e&&"all"!==e||(console.log("[build] STEP1.5: convertCharImage Start"),await(async()=>{const e=o.TMP_PREFIX+"DB/Texture2D/",t=o.TARGET_PREFIX+"char/";await n.ensureDir(t);const a=await n.readdir(e);let i=[];for(let t=0;t<a.length;t++){const n=a[t];if(n.includes("[alpha]")){const t=await m.imgSizeOf(e+n);if(t.width>=1024&&t.height>=1024){const t=n.substr(0,n.indexOf("[alpha]"));let o=u.toSkinFile(t);o||console.log(r.default.red("unknown skin"),t);const s=new RegExp(`^${t.replace("+","\\+")}(?: #\\d+)?\\.png$`),l=(await Promise.all(a.filter(e=>s.test(e)).map(async t=>({name:t,...await m.imgSizeOf(e+t)})))).find(e=>e.height>=1024);l?o&&i.push([l.name,n,o+".png"]):console.log(r.default.red("cant find file",n))}}}for(let a=0;a<i.length;a+=2){const o=i.slice(a,a+2);await Promise.all(o.map(async([a,o,i])=>{await n.pathExists(t+i)||(await l.exec(["magick convert",`"${c.resolve(e+a)}"`,`"${c.resolve(e+o)}"`,"-alpha off -resize 1024x1024 -compose copyopacity -composite",`"${t}${i}"`].join(" ")),console.log(r.default.green("converted"),i))}))}})()),"item"!==e&&"all"!==e||(console.log("[build] STEP2.5: convertItemImages Start"),await _.convertItemImages()),"map"!==e&&"all"!==e||(console.log("[build] STEP3.5: convertStage(image) Start"),await v(e)),"skill"!==e&&"all"!==e||(console.log("[build] STEP6.5: convertSkillIcon Start"),await(async()=>{const e=i.map(d.skill_table,h.translateSkillIcon);await n.ensureDir(o.TARGET_PREFIX+"skills");for(let t=0;t<e.length;t++){const[a,i]=e[t];if(a&&i)try{await n.copy(o.TMP_PREFIX+"DB/Sprite/skill_icon_"+a+".png",o.TARGET_PREFIX+"skills/"+i+".png")}catch(e){console.log(r.default.red("[ERROR]"),`icon not found: ${a} ${i}`)}}})()),"cv"!==e&&"all"!==e||(console.log("[build] STEP7.7: convertCVAudio Start"),await(async()=>{await n.ensureDir(o.TARGET_PREFIX+"cv");const e=i.map(d.charword_table,e=>{const t=e.charId.split("_")[2];return[o.TMP_PREFIX+"DB/AudioClip/assets/torappu/dynamicassets/audio/sound_beta_2/voice/"+e.voiceAsset.toLowerCase()+".wav",o.TARGET_PREFIX+"cv/"+`${t}_${e.voiceId}.ogg`]}).filter(Boolean);await new Promise(t=>{s.default.forEachLimit(e,8,async([e,t])=>{const a=`ffmpeg -i "${e}" -c libvorbis -n -v quiet -ab 128k "${t}"`;if(!await n.pathExists(t))try{const e=await l.exec(a);if(e.stderr)throw console.log(r.default.red("[error]"),e.stderr),e.stderr;console.log(r.default.blue("processed"),a)}catch(e){e.stderr&&console.log(r.default.red("[error]"),e.stderr)}},e=>{t()})})})()),console.log("[build] All Finished")}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(3),o=a(12),r=a(2),i=a(4),s=a(6),l=e=>{const t=n.uniq(e);return 1===t.length?t:e};let c=new Set;t.toSkinFile=e=>{const t=e.match(/(char|token|trap)_(\d+)_([A-Za-z0-9]+)/);if(t){const a=e.replace(`${t[0]}_`,"").replace("#","-"),n=a.split("-")[0],o=a.split("-")[1],s=a.length===e.length?e:t[0]+(o?"@"+n+"#"+o:"#"+a);if(r.skin_table.charSkins[s]){const e=a,n={"1+":2,2:3},o=t[3]+"-"+(n[e]||e);return i.firstCase(o)}}},t.translateCharacter=(e,a)=>{let d={};if(d.id=e.id,d.name=e.name,d.rarity=e.rarity,e.description&&(d.description=e.description.replace(/\\n/g,"\n")),e.canUseGeneralPotentialItem||(d.canUseGeneralPotentialItem=e.canUseGeneralPotentialItem),e.potentialItemId&&(d.potentialItemId=e.potentialItemId),d.displayNumber=e.displayNumber,d.appellation=e.appellation,d.position=e.position,d.tagList=e.tagList,d.displayLogo=e.displayLogo,d.itemUsage=e.itemUsage,d.itemDesc=e.itemDesc,d.itemObtainApproach=e.itemObtainApproach,d.maxPotentialLevel=e.maxPotentialLevel,d.tokenKey=e.tokenKey,e.team>-1&&(d.team={key:r.handbook_team_table[e.team+""].teamKey,name:r.handbook_team_table[e.team+""].teamName,color:r.handbook_team_table[e.team+""].color}),d.profession=o.Profession[e.profession],e.potentialRanks&&(d.potentialRanks=e.potentialRanks.map(e=>e.description)),e.phases&&e.phases[0]&&e.phases[0].maxLevel){d.maxLevel=[],d.rangeId=[],d.evolveCost=[];const t=["maxHp","atk","def"],a=["magicResistance","cost","blockCnt","attackSpeed","baseAttackTime","respawnTime","hpRecoveryPerSec","spRecoveryPerSec","tauntLevel","massLevel","baseForceLevel","stunImmune","silenceImmune"];e.phases.forEach((e,n)=>{0===n&&(t.forEach(t=>{d[t]=[e.attributesKeyFrames[0].data[t]]}),a.forEach(e=>{d[e]=[]})),d.maxLevel.push(e.maxLevel),d.rangeId.push(e.rangeId),t.concat(a).forEach(t=>{d[t].push(e.attributesKeyFrames[1].data[t])}),e.evolveCost&&d.evolveCost.push(e.evolveCost.map(e=>{return{name:r.item_table.items[e.id].name,count:e.count}}))}),d.rangeId=l(d.rangeId),a.concat(t).forEach(e=>{d[e]=l(d[e])}),i.isEmpty(d.evolveCost)&&delete d.evolveCost}{const e=(e,t,a)=>{const n=e[t];1===n.length&&n[0]===a&&delete e[t]};e(d,"hpRecoveryPerSec",0),e(d,"spRecoveryPerSec",1),e(d,"tauntLevel",0),e(d,"massLevel",0),e(d,"baseForceLevel",0),e(d,"stunImmune",!1),e(d,"silenceImmune",!1)}e.skills&&(d.skills=[],e.skills.forEach(e=>{if(!e.skillId)return;const t=r.skill_table[e.skillId];if(t){const a={name:t.levels[0].name,phase:e.unlockCond.phase};1!=e.unlockCond.level&&(a.level=e.unlockCond.level);const n=e.levelUpCostCond.map(e=>e.levelUpCost&&e.levelUpCost.map(e=>{return{name:r.item_table.items[e.id].name,count:e.count}}));n.length&&null!=n[0]&&(a.masterCost=n),d.skills.push(a)}else console.log(s.default.red("[error]"),e.skillId,"skill not found")}),d.skills.length||delete d.skills),e.allSkillLvlup&&e.allSkillLvlup.length&&(d.skillCost=e.allSkillLvlup.map(e=>e.lvlUpCost?e.lvlUpCost.map(e=>{return{name:r.item_table.items[e.id].name,count:e.count}}):[])),e.talents&&(d.talents=[],e.talents.forEach(e=>{if(!e.candidates)return;const t={name:e.candidates[0].name,phase:e.candidates[0].unlockCondition.phase,level:e.candidates[0].unlockCondition.level,desc:e.candidates[0].description,upgrades:e.candidates.slice(1).map(t=>{const a={};return e.candidates[0].name!=t.name&&(a.name=t.name),a.phase=t.unlockCondition.phase,t.unlockCondition.level||1==t.unlockCondition.level||(a.level=t.unlockCondition.level),t.requiredPotentialRank&&(a.potential=t.requiredPotentialRank),a.desc=t.description,a})};1!=e.candidates[0].unlockCondition.level&&(t.level=e.candidates[0].unlockCondition.level),d.talents.push(t)})),a&&(d.cv=a.infoName,d.art=a.drawName);const u=n.filter(r.skin_table.charSkins,t=>t.charId===e.id);u&&u.length>0&&(d.skins=u.map(e=>{const a={name:e.displaySkin.skinGroupName,file:t.toSkinFile(e.portraitId)+".png"};return c.add(e.portraitId),e.displaySkin.drawerName&&e.displaySkin.drawerName.toLowerCase()!==d.art.toLowerCase()&&(a.drawer=e.displaySkin.drawerName),a})),r.charword_table[e.id+"_CN_011"]&&(d.appearance=r.charword_table[e.id+"_CN_011"].voiceText);const p=r.char_extra_table[d.name];return p&&Object.assign(d,p),d}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.PIONEER="先锋",e.WARRIOR="近卫",e.TANK="重装",e.SPECIAL="特种",e.SNIPER="狙击",e.CASTER="术师",e.MEDIC="医疗",e.SUPPORT="辅助",e.TOKEN="召唤",e.TRAP="陷阱"}(t.Profession||(t.Profession={}))},function(e,t){e.exports=require("prettier")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("image-size")},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(2),o=a(4);t.translateItem=e=>o.purge({name:e.name,rarity:e.rarity,iconid:e.iconId,description:e.description.replace(/\\n/g,"\n"),stackiconid:e.stackIconId,usage:e.usage,obtainapproach:e.obtainApproach,itemtype:e.itemType,dropBy:e.stageDropList.map(e=>{const t=`[[${n.stage_table.stages[e.stageId].code}]]`;let a;!function(e){e.SOMETIMES="罕见",e.OFTEN="小概率",e.USUAL="概率",e.ALMOST="大概率",e.ALWAYS="固定掉落"}(a||(a={}));const o=a[e.occPer];return(o?t+","+o:t)+","}).join(";"),craftBy:e.buildingProductList.map(e=>{let t;return function(e){e.MANUFACTURE="制造站",e.WORKSHOP="加工站"}(t||(t={})),t[e.roomType]}).join(",")})},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(3),o=a(2),r=a(18),i=a(1),s=a(0),l=e=>{const t=o.item_table.items[e.id];if(t)return t.name},c=e=>{const t=o.character_table[e.id];return t?t.name:e.id};t.translateStagePreview=e=>{const t=n.find(o.stage_table.stages,t=>t.code===e.name);if(t){return[i.TMP_PREFIX+`DB/Texture2D/assets/torappu/dynamicassets/arts/ui/stage/mappreviews/${t.stageId}.png`,i.TARGET_PREFIX+`maps/${e.preview}.png`]}},t.translateStage=()=>n.filter(o.stage_table.stages,e=>!e.stageId.includes("#f#")&&!!e.name&&"剿灭作战"!==e.code).map(e=>{let t={};const a=e.hardStagedId?o.stage_table.stages[e.hardStagedId]:null;if(e.code&&(t.name=e.code.trim(),t.preview="MAP-"+t.name),e.name&&(t.alterName=e.name.trim()),e.description&&(t.description=e.description.replace(/\\n/g,"\n")),a&&a.description&&(t.hardDesc=a.description.replace("<@lv.fs>附加条件：</>\\n","").replace(/\\n/g,"\n")),e.dangerLevel&&"-"!==e.dangerLevel&&(t.dangerLevel=e.dangerLevel),e.canPractice||(t.canPractice=e.canPractice),e.canBattleReplay||(t.canBattleReplay=e.canBattleReplay),e.apCost&&(t.apCost=e.apCost),e.apFailReturn&&(t.apFailReturn=e.apFailReturn),e.practiceTicketCost&&1!==e.practiceTicketCost&&-1!==e.practiceTicketCost&&(t.practiceTicketCost=e.practiceTicketCost),e.expGain&&e.expGain!==10*e.apCost&&(t.expGain=e.expGain),e.goldGain&&e.goldGain!==10*e.apCost&&(t.goldGain=e.goldGain),e.hilightMark&&(t.hilightMark=e.hilightMark),e.bossMark&&(t.bossMark=e.bossMark),e.isPredefined&&(t.isPredefined=e.isPredefined),e.stageDropInfo&&e.stageDropInfo.displayDetailRewards){const n=e.stageDropInfo.displayDetailRewards,r=a&&a.stageDropInfo&&a.stageDropInfo.displayDetailRewards,d=e=>e&&e.map(l).filter(Boolean),u=d(n.filter(e=>1===e.dropType&&"CHAR"!==e.type)),p=n.filter(e=>1===e.dropType&&"CHAR"===e.type).map(c).filter(Boolean),m=d(r&&r.filter(e=>1===e.dropType)),f=d(n.filter(e=>2===e.dropType)),g=d(n.filter(e=>3===e.dropType)),h=d(n.filter(e=>4===e.dropType));u&&u.length&&(t.firstDrop=u),p&&p.length&&(t.firstCharDrop=p),m&&m.length&&(t.firstHardDrop=m),f&&f.length&&(t.commonDrop=f),g&&g.length&&(t.specialDrop=g),h&&h.length&&(t.extraDrop=h);const y=((e,t)=>{const a=i.TMP_PREFIX+`ArknightsGameData/levels/${e.toLowerCase()}.json`;if(s.pathExistsSync(a))return JSON.parse(s.readFileSync(a,"utf-8")).enemyDbRefs.map(e=>e.id).map(e=>{const t=o.enemy_handbook_table[e];if(t)return t.name}).filter(Boolean);return[]})(e.levelId,e.stageId);y&&y.length&&(t.enemies=y)}return r.purge(t)})},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.purge=e=>(Object.keys(e).forEach(t=>0!==e[t]&&!e[t]&&delete e[t]),e)},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(2);t.translateEnemy=e=>{const t=n.enemy_table[e.enemyId],a={};if(a.id=e.enemyId,a.name=e.name,a.index=e.enemyIndex,a.level=e.enemyLevel,a.description=e.description,e.enemyRace&&(a.enemyRace=e.enemyRace),a.attackType=e.attackType,e.ability&&(a.ability=e.ability),a.handbook=[e.endure,e.attack,e.defence,e.resistance],t){if(t.length<1)return void console.log(t);const[e,n]=t,o=["maxHp","atk","def","magicResistance","moveSpeed","baseAttackTime","massLevel","stunImmune","silenceImmune"];o.forEach(t=>{e.enemyData.attributes[t].m_value&&(a[t+"0"]=e.enemyData.attributes[t].m_value)}),e.enemyData.rangeRadius.m_value&&(a.rangeRadius0=e.enemyData.rangeRadius.m_value),n&&(o.forEach(e=>{n.enemyData.attributes[e].m_value&&(a[e+"1"]=n.enemyData.attributes[e].m_value)}),n.enemyData.rangeRadius.m_value&&(a.rangeRadius1=n.enemyData.rangeRadius.m_value))}return a}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.translateSkillIcon=e=>[e.iconId||e.skillId,e.levels[0].name],t.translateSkill=e=>{const t={},a=e.levels[0];return t.name=a.name,t.skillType=a.skillType,t.spType=a.spData.spType,a.rangeId&&(t.rangeId=a.rangeId),t.levels=e.levels.map(e=>{const t={};e.duration&&e.duration>0&&(t.duration=e.duration),e.rangeId!==a.rangeId&&(t.rangeId=e.rangeId),e.spData.spCost&&(t.spCost=e.spData.spCost),e.spData.initSp&&(t.initSp=e.spData.initSp),0!=e.spData.increment&&1!=e.spData.increment&&(t.increment=e.spData.increment);const n=e.blackboard.reduce((e,t)=>(e[t.key]=t.value,e),{});return t.description=e.description.replace(/\{-?(.+?)(:.+?)?\}/g,(e,t,a)=>{t=t.toLowerCase();const o=(e.startsWith("{-")?-1:1)*n[t];return":0%"==a?(100*o).toFixed()+"%":":0.0%"==a?(100*o).toFixed(1)+"%":String(o)}).replace(/攻击间隔(?:<@ba\.vdown>增大<\/>|<@ba\.vup>.*?缩短<\/>)/g,e=>{const t=n.base_attack_time;return e+`(${t>=0?"+":""}${t})`}).replace(/攻击前摇/g,e=>{const t=n["attack@stun"];return e+`(${t>=0?"+":""}${t})`}),t}),t}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(3),o=a(2);t.translateCharword=()=>{const e="cn_001/cn_002/cn_003/cn_004/cn_005/cn_006/cn_007/cn_008/cn_009/cn_010/cn_011/cn_012/cn_013/cn_014/cn_017/cn_018/cn_019/cn_020/cn_021/cn_022/cn_023/cn_024/cn_025/cn_026/cn_027/cn_028/cn_029/cn_030/cn_031/cn_032/cn_033/cn_034/cn_036/cn_037/cn_042".split("/");return n.reduce(o.charword_table,(t,a)=>{const n=o.character_table[a.charId];return t[n.name]||(t[n.name]={id:a.charId.split("_")[2],name:n.name},e.forEach(e=>t[n.name][e]="无")),t[n.name][a.voiceId.toLowerCase()]=a.voiceText.replace(/\n/g,"<br>"),t},{})}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(0),o=a(8),r=a(1),i=a(5),s=a(23),l=a(4);t.convertItemImages=async()=>{const e=r.TMP_PREFIX+"item_icons_hub.ab/Assets/Texture2D/",t=await n.readdir(e),a=[];for(const n of t.filter(e=>e.endsWith(".png")&&!e.includes("_alpha")&&!e.includes("_out"))){const t=n,r=/_(\d+)\.png/.test(n)?n.replace(/_(\d+)\.png/,"_alpha_$1.png"):n.replace(".png","_alpha.png"),s=n.replace(".png","_out.png");a.push([s,n+".meta"]),await o.exec(`magick convert "${e+t}" "${i.resolve(e+r)}" -alpha off -compose copyopacity -composite ${e}${s}`)}await n.ensureDir(`${r.TARGET_PREFIX}items`);for(const[t,i]of a){const a=s.parse(await n.readFile(e+i,"utf-8"));for(const n of a.TextureImporter.spriteSheet.sprites){const a=(await l.imgSizeOf(e+t)).width,i=`${Math.round(n.rect.width)}x${Math.round(n.rect.height)}+${Math.round(n.rect.x)}+${Math.round(a-n.rect.y-n.rect.height)}`;console.log(i),await o.exec(`magick convert "${e+t}" -crop ${i} ${r.TARGET_PREFIX}items/${n.name}.png`)}}}},function(e,t){e.exports=require("yaml")},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(0),o=a(1);t.default=async()=>{await n.remove(o.TARGET_PREFIX),console.log("[clean] All Finished")}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(26),o=a(0),r=a(1),i=a(6),s=a(5),l=a(4);a(30).config();const c=async(e,t,a=!1,n="")=>{const l=await o.readdir(r.TARGET_PREFIX+e+"/");let c=n,d=0;a&&console.log(i.default.red("force mode enabled")),c&&console.log(i.default.green(`start skip to ${n}`));for(let n=0;n<l.length;n+=3){const o=async e=>{const n=s.basename(e);if(c)return++d,void(c===n&&(console.log(i.default.green(`skipped ${d}/${l.length} files`)),c=""));let o=!1;do{try{if(a||!await t.getImageInfo(n)){const a=await t.uploadFile(e);console.log("[sync]",n,a.upload?i.default.green("uploaded")+" "+a.upload.result:i.default.red("error"))}o=!0}catch(e){console.log(i.default.red("[sync] upload failed => [auto retry]"),n)}}while(!o)},u=l.slice(n,n+3).map(t=>r.TARGET_PREFIX+e+"/"+t);await Promise.all(u.map(o))}},d=async(e,t,a)=>{if(await e.raw(t)!==a){console.log("[sync]",i.default.greenBright("diff detected:"),t);const n=await e.edit({title:t,text:a});n.error&&console.log(i.default.red("[syncPage]"),n)}},u=async(e,t,a,n=r.TARGET_PREFIX)=>{const i=n+a,s=await o.readFile(i,"utf-8");return await d(e,t,s)},p="Enemy/Stage/Character/Item/Util/Charword".split("/"),m=async e=>{const t=t=>(async(e,t,a)=>{const n=await e.raw(t);n&&await o.writeFile(a,n)})(e,`Module:${t}`,`src/module/${t}.lua`);for(const e of p)console.log("pull",e),await t(e)},f=async(e,t)=>{const a=await e.purge({generator:"transcludedin",titles:t,gtilimit:500});console.log(l.formatJSON(a))},g=async(e,t,a=r.TARGET_PREFIX)=>{const n=JSON.parse(await o.readFile(a+t,"utf-8"));for(let t=0;t<n.length;t++){const a=n[t];await d(e,a.title,a.text)}};t.default=async e=>{const t=new n.WikiBot("https://arknights.huijiwiki.com/",process.env.user,process.env.session);await t.getToken();const a=e.mode,i=e.force;"pull"===a&&(console.log("[sync] pull modules start"),await m(t)),"push"===a&&(console.log("[sync] push modules start"),await(async e=>{const t=t=>u(e,`Module:${t}`,`src/module/${t}.lua`,"");for(const e of p)await t(e)})(t)),"char"!==a&&"all"!==a||(console.log("[sync] uploadImage(char) start"),await c("char",t,i)),"itemimg"!==a&&"all"!==a||(console.log("[sync] uploadImage(item) start"),await c("items",t,i,e.skip)),"map"!==a&&"all"!==a||(console.log("[sync] uploadImage(map) start"),await c("maps",t,i)),"cv"!==a&&"all"!==a||await c("cv",t,i),"skillimg"!==a&&"all"!==a||(console.log("[sync] uploadImage(skill) start"),await c("skills",t,i)),"module"!==a&&"all"!==a||(console.log("[sync] uploadModuleData start"),await(async e=>{await Promise.all([u(e,"Module:Character/data","CharacterData.lua"),u(e,"Module:Item/data","ItemData.lua"),u(e,"Module:Stage/data","StageData.lua"),u(e,"Module:Enemy/data","EnemyData.lua"),u(e,"Module:Skill/data","SkillData.lua")])})(t)),"book"!==a&&"all"!==a||(console.log("[sync] sync char.*sync.json start"),await g(t,"Char.sync.json"),await g(t,"CharSkill.sync.json"),await g(t,"CharHandbook.sync.json"),await g(t,"CharWord.sync.json")),"enemy"!==a&&"all"!==a||(console.log("[sync] sync enemy.*sync.json start"),await g(t,"Enemy.sync.json")),"stage"!==a&&"all"!==a||(console.log("[sync] sync stage.*sync.json start"),await g(t,"Stage.sync.json")),"tab"!==a&&"all"!==a||await(async(e,t,a)=>{const n=await o.readFile(r.TARGET_PREFIX+a,"utf-8");await d(e,t,n)})(t,"Data:Charword.tab","CharWord.tab.json"),"purge"!==a&&"all"!==a||(await f(t,"template:NavboxEnemy"),await f(t,"template:NavboxChar"),await f(t,"template:NavboxStage")),console.log("[sync] All Finished")}},function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=a(27),o=a(28),r=a(29),i=a(0),s=a(5);t.WikiBot=class{constructor(e,t,a){this.BASE="https://www.huijiwiki.com/",this.BASE=e,this.user=t,this.session=a,this.client=n.default.create({headers:{common:{Cookie:`huijiUserID=${t}; huiji_session=${a};`},post:{"Content-Type":"application/x-www-form-urlencoded"}}})}get API(){return this.BASE+"api.php"}get RAW(){return this.BASE+"index.php?action=raw&title="}async apiPagination(e){let t=await this.client.get(e);if(t){let e=t.data.query.pages,a=Object.keys(e);if(a.length>0&&"-1"!=a[0])return e[a[0]]}}async getToken(){const e=await this.client.get(this.API+"?action=query&meta=tokens&format=json");return this.token=e.data.query.tokens.csrftoken}async ask(e,t=0,a=50){const n=this.API+`?action=ask&format=json&query=${encodeURI(e+`|limit=${a}|offset=${t}`)}`,o=await this.client.get(n);console.log("[ASK]",n);const r=o.data.query.results;if(o.data["query-continue-offset"]){const t=await this.ask(e,o.data["query-continue-offset"],a);return{...r,...t}}return r}async edit(e){const t=o.stringify({action:"edit",format:"json",token:this.token,...e}),a=await this.client.post(this.API,t);return a.data.edit||a.data}async raw(e){try{return(await this.client.get(this.RAW+encodeURI(e))).data}catch(e){return"Request failed with status code 404"!==e.message&&console.log(e.message),""}}async delete(e,t=""){const a=o.stringify({action:"delete",format:"json",token:this.token,title:e,reason:t}),n=await this.client.post(this.API,a);return n.data.delete||n.data}async purge(e){const t=o.stringify({action:"purge",format:"json",...e}),a=await this.client.post(this.API,t);return a.data.purge||a.data}async transferFile(e,t){let a=this.API;return(await this.client.post(a,o.stringify({format:"json",action:"upload",url:t,filename:e,comment:`从${t}搬运文件：${e}。(via nodejs)`,text:"",token:this.token}),{timeout:5e3})).data}async uploadFile(e,t){let a=this.API;const n=t||i.createReadStream(e),o=s.basename(e);let l=new r;return l.append("format","json"),l.append("action","upload"),l.append("filename",o),l.append("ignorewarnings","true"),l.append("token",this.token),l.append("file",n),(await this.client.post(a,l,{timeout:1e4,headers:l.getHeaders()})).data}async getImageInfo(e){let t=`${this.API}?action=query&titles=File:${encodeURI(e)}&prop=imageinfo&&iiprop=url&format=json`,a=await this.apiPagination(t);return a&&a.imageinfo[0].url}}},function(e,t){e.exports=require("axios")},function(e,t){e.exports=require("querystring")},function(e,t){e.exports=require("form-data")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("yargs")}]));
//# sourceMappingURL=main.js.map